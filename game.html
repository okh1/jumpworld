<html>
<head>
    <style>
        body {
            margin: 0px;
            padding: 0px;
            text-align: center;
        }

        canvas {
            outline: 0;
            border: 1px solid #000;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.4.js"></script>
    <script src="http://cs.stanford.edu/people/karpathy/convnetjs/build/convnet-min.js"></script>
</head>
<body onload="load()">
    <canvas id='c'></canvas> <br />
    <div>To Jump, press Arrow UP or <button onclick="jump()">Jump</button></div>
    <div style="margin-top:2px;">
        <span><button onclick="startTrainingTable()">Start Training with Table</button></span>
        <span><button onclick="startTrainingNN()">Start Training with Neural Network</button></span>
        <span><button id="btnAgent" onclick="changeAgent()">Stop Agent</button></span>
        <span><button id="btnStop" onclick="stopTraining()" style="display: none;">Stop Training</button></span>
    </div>
    <div><span>Distance: </span><span id="spanDistance"></span></div>
    <div><span>Score: </span><span id="spanScore"></span></div>
    <div><span>Highest Score: </span><span id="spanHighestScore"></span></div>
    <div><span>Hero Y: </span><span id="spanHeroY"></span></div>
    <div><span>Value of Doing Nothing: </span><span id="spanValueNothing"></span> <span>Value of Jumping: </span><span id="spanValueJumping"></span></div>
    <div style="margin-top:1px;"><span>Hero Interval in <i>ms</i>: <input id="txtFH" style="width: 30px;" value="5" /></span><span> Obstacles Interval in <i>ms</i>: <input id="txtFO" style="width: 30px;" value="10" /></span> <button onclick="changeFrequency()">Change</button></div>
    
    <script>
        var width = 900; var height = 450; //Canvas width and height
        c = document.getElementById('c');
        c.width = width; c.height = height;
        ctx = c.getContext('2d');
        var x = [0, 500]; var n = 2; //Obstacles
        var hero_x = 450; var hero_y = 0; var direction = 'null'; var score = 0; var score2 = 0; var flag = [1, 1]; var highestscore = 0;
        var layer_defs; var net; var trainer; var random = 1; //Neural network
        var inputs; var outputs; //Table
        var training = false; var trainingNN = false; var trainingTable = false; var agent = true; var frequency_obs = 10; var frequency_hero = 5; var obs_interval; var jump_interval;

        function load() {
            setupNN();
            setupTable();

            obs_interval = setInterval(start, frequency_obs);
        }

        $(document).keydown(function (eventObject) {
            if (eventObject.keyCode == 38) {
                //If arrow UP key is pressed, then jump
                jump();
            }
        });

        function changeFrequency() {
            frequency_obs = $("#txtFO").val();
            frequency_hero = $("#txtFH").val();
            clearInterval(obs_interval);
            obs_interval = setInterval(start, frequency_obs);
        }

        function changeAgent() {
            if (agent) {
                agent = false; $("#btnAgent").text("Start Agent"); alert("Now you're playing!");
            }
            else {
                agent = true; $("#btnAgent").text("Stop Agent"); alert("Now the agent is playing!");
            }
        }

        function startTrainingNN() {
            training = true; trainingNN = true; trainingTable = false; setupNN(); $("#btnStop").show();
        }

        function startTrainingTable() {
            training = true; trainingTable = true; trainingNN = false; setupTable(); $("#btnStop").show();
        }

        function stopTraining() {
            training = false; $("#btnStop").hide();
        }

        function clear() {
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = 'grey';
            ctx.fillRect(0, height - 100, width, 100);
        }

        function draw() {
            for (var i = 0; i < n; i++) {
                ctx.fillStyle = 'black';
                ctx.fillRect(x[i], height - 100 - 25, 25, 25);
            }

            ctx.fillStyle = 'red';
            ctx.fillRect(hero_x, hero_y + (height - 100 - 50), 50, 50);
        }

        function move() {
            for (var i = 0; i < n; i++) {
                x[i] -= 5;
                if (x[i] < 0)
                    x[i] = width;
            }
        }

        function drawJump() {
            if (direction == 'up')
                hero_y -= 2;
            else if (direction == 'down')
                hero_y += 2;

            if (hero_y <= -150) {
                direction = 'down';
            }

            else if (hero_y >= 0) {
                hero_y = 0;
                window.clearInterval(jump_interval);
                direction = 'null';
            }
        }

        function jump() {
            if (direction == 'null') {
                direction = 'up';
                jump_interval = setInterval(drawJump, frequency_hero);
            }
        }

        function updateScore() {
            $("#spanDistance").text(getDistance());
            for (var i = 0; i < 2; i++) {
                if (Math.abs(x[i] - hero_x) <= 50) {
                    if (flag[i] == 1) {
                        if (hero_y >= -25) {
                            if (score2 > highestscore) { highestscore = score2; $("#spanHighestScore").text(highestscore); }
                            score2 = 0; score--;
                            flag[i] = 0;
                        }
                        else if (x[i] - hero_x == -30) {
                            score2++; score++;
                            flag[i] = 0;
                        }

                    }
                }
                else
                    flag[i] = 1;
            }
            $("#spanScore").text(score2);
            $("#spanHeroY").text(hero_y);
            $("#spanValueNothing").text(nnet(getDistance(), 0).toFixed(2));
            $("#spanValueJumping").text(nnet(getDistance(), 1).toFixed(2));
        }

        function getDistance() {
            var min = 1000; var index = 0;
            for (var i = 0; i < 2; i++) {
                if (x[i] - hero_x - 50 >= 0 && x[i] - hero_x - 50 < min) {
                    min = x[i] - hero_x - 50; index = i;
                }
            }
            return min;
        }



        function setupNN() {
            layer_defs = [];
            layer_defs.push({ type: 'input', out_sx: 1, out_sy: 1, out_depth: 2 });
            layer_defs.push({ type: 'fc', num_neurons: 5, activation: 'sigmoid' });
            layer_defs.push({ type: 'regression', num_neurons: 1 });
            net = new convnetjs.Net();
            net.makeLayers(layer_defs);
            trainer = new convnetjs.SGDTrainer(net, { learning_rate: 0.01, momentum: 0.9, batch_size: 1, l2_decay: 0.001 });
        }

        function setupTable() {
            var ex = [0, 0];
            inputs = [ex]; outputs = [0];
        }

        function start() {
            clear();
            draw();

            if (agent) {
                var old_distance = getDistance();
                var action = chooseaction(old_distance);
                var old_score = score;
                if (action == 1)
                    jump();
                move(); updateScore();

                if (training) {
                    var q = updateq(old_distance, action, getDistance(), old_score, score);
                    if (trainingNN) {
                        var xx = new convnetjs.Vol([old_distance, action]);
                        trainer.train(xx, [q]);
                    }
                    else if (trainingTable) {
                        var input = [old_distance, action];
                        if (indexOf(input) == -1) {
                            inputs.push(input); outputs.push(0);
                        }
                        outputs[indexOf(input)] = q;
                    }
                }
            }
            else {
                move(); updateScore();
            }
        }


        function updateq(old_distance, action, new_distance, old_score, new_score) {
            var numberofactions = 2;
            var alfa = 0.7;
            var gamma = 0.9;
            var X = 0;
            var reward = 0;
            if (new_score > old_score)
                reward = 1;
            else if (new_score < old_score)
                reward = -10;

            if (reward == 0) {
                var qvalues = [nnet(new_distance, 0), nnet(new_distance, 1)];
                X = reward + gamma * Math.max.apply(Math, qvalues);
            }
            else
                X = reward;

            var q = (1 - alfa) * nnet(old_distance, action) + alfa * X;
            return q;
        }

        function nnet(distance, action) {
            if (trainingNN) {
                var xx = new convnetjs.Vol([distance, action]);
                var predicted_values = net.forward(xx);
                return predicted_values.w[0];
            }
            else if (trainingTable) {
                var xx = [distance, action];
                if (indexOf(xx) != -1)
                    return outputs[indexOf(xx)];
                else
                    return 0;
            }
        }

        function indexOf(xx) {
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i][0] == xx[0] && inputs[i][1] == xx[1])
                    return i;
            }
            return -1;
        }

        function chooseaction(distance) {
            //0 do nothing, 1 jump
            var action = 0;
            if (Math.random() > 1 && random == 1) {
                if (Math.random() > 0.5 || direction != 'null')
                    action = 0;
                else
                    action = 1;
            }
            else {
                if (nnet(distance, 0) >= nnet(distance, 1) || direction != 'null')
                    action = 0;
                else
                    action = 1;
            }
            return action;
        }
    </script>
</body>
</html>
